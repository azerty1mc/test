#!/bin/bash
set -euo pipefail

if [ "$EUID" -ne 0 ]; then
  echo "run as root"
  exit 1
fi

# reapply firewall rules
iptables -F
iptables -X

# default deny
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# allow loopback
iptables -A INPUT -i lo -j ACCEPT

# allow established
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# allow icmp
iptables -A INPUT -p icmp -j ACCEPT

# allow http
iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# allow ssh from internal only (optional)
# iptables -A INPUT -p tcp --dport 22 -s 10.0.0.0/24 -j ACCEPT

# nat forwarding (router role)
iptables -t nat -F
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# allow forwarding internal -> external
iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# kill malicious listeners
pkill -f "nc -l" 2>/dev/null || true
pkill -f "ncat -l" 2>/dev/null || true
pkill -f "gunicorn" 2>/dev/null || true
pkill -f "flask" 2>/dev/null || true
pkill -f "telnetd" 2>/dev/null || true

# kill suspicious python servers
pkill -f "python -m http.server" 2>/dev/null || true
pkill -f "python3 -m http.server" 2>/dev/null || true

# disable malicious services
for s in bind_shell sys flaskapp backdoor revshell; do
  systemctl stop "$s" 2>/dev/null || true
  systemctl disable "$s" 2>/dev/null || true
  rm -f /etc/systemd/system/"$s".service 2>/dev/null || true
done

# disable malicious timers
for t in bind_shell.timer sys.timer revshell.timer; do
  systemctl stop "$t" 2>/dev/null || true
  systemctl disable "$t" 2>/dev/null || true
  rm -f /etc/systemd/system/"$t" 2>/dev/null || true
done

systemctl daemon-reload

# clean cron
rm -f /var/spool/cron/crontabs/"*" 2>/dev/null || true
sed -i '/nc -l/d;/ncat -l/d;/bash -i/d;/curl .*sh/d' /etc/crontab 2>/dev/null || true

for d in /etc/cron.d /etc/cron.hourly /etc/cron.daily /etc/cron.weekly /etc/cron.monthly; do
  [ -d "$d" ] && grep -lE 'nc -l|ncat -l|bash -i|curl \.\*sh' "$d"/* 2>/dev/null | xargs -r rm -f
done

# verify http is running
systemctl restart apache2 2>/dev/null || true
systemctl restart nginx 2>/dev/null || true

# verify ip forwarding
echo 1 > /proc/sys/net/ipv4/ip_forward

echo "rout complete"
